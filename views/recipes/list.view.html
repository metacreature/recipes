<?php require_once (DOCUMENT_ROOT . '/views/includes/header.view.html'); ?>
<?php require_once (DOCUMENT_ROOT . '/views/includes/navigation.view.html'); ?>

<div id="recipe_list_filter">
    <?php 
    echo $form->printStartTag();
    $class = $form->printInput('user_id') ? ' count5' : ' count4';
    echo '<div class="filter_input_wrapper'. $class .'">';
    echo '  <div class="field_wrapper">' . $form->printInput('user_id') . '</div>';
    echo '  <div class="field_wrapper">' . $form->printInput('category_id') . '</div>';
    echo '  <div class="field_wrapper">' . $form->printInput('tag_id') . '</div>';
    echo '  <div class="clear medium_visible"></div>';
    echo '  <div class="field_wrapper">' . $form->printInput('ingredients_id') . '</div>';
    echo '  <div class="field_wrapper">' . $form->printInput('recipe_name') . '</div>';
    echo '  <div class="clear"></div>';
    echo '</div>';
    echo $form->printSubmit('<img src="/static/images/icons/search-sharp.svg">', 'search', '/recipes/list/list');
    echo '<div class="clear"></div>';
    echo $form->printEndTag();
    ?>
</div>

<div id="recipe_list">
    <a class="entry add_recipe" href="/recipes/editor">
        <img src="/static/images/icons/add-circle-outline.svg">
        <span><?php echo LANG_RECIPE_LIST_ADD; ?></span>
    </a>

</div>

<script>

    var recipe_list = <?php echo json_encode($recipe_list); ?>

    $('select[name="user_id[]"]').select2({
        placeholder: "<?php echo LANG_RECIPE_LIST_FILTER_USER; ?>",
        allowClear: true,
        width: '100%'
    });
    $('select[name="category_id[]"]').select2({
        placeholder: "<?php echo LANG_RECIPE_LIST_FILTER_CATEGORY; ?>",
        allowClear: true,
        width: '100%'
    });
    $('select[name="tag_id[]"]').select2({
        placeholder: "<?php echo LANG_RECIPE_LIST_FILTER_TAG; ?>",
        allowClear: true,
        width: '100%'
    });
    $('select[name="ingredients_id[]"]').select2({
        placeholder: "<?php echo LANG_RECIPE_LIST_FILTER_INGREDIENTS; ?>",
        allowClear: true,
        width: '100%'
    });
    $('input[name="recipe_name"]').attr('placeholder', "<?php echo LANG_RECIPE_LIST_FILTER_NAME; ?>");

    function buildRecipeList(recipe_list) {
        for(row of recipe_list) {
            var html = '<div class="entry public'+row.public+'" data-recipe_id="'+row.recipe_id+'">';
                html += '<div class="recipe_name">'+row.recipe_name+'</div>';
                html += '<div class="category_name">'+row.category_name+'</div>';
                if (row.image_name) {
                    html += '<img src="/gallery/recipes/'+row.image_name+'_s.webp">';
                } else {
                    html += '<img src="/gallery/recipes/blank_s.webp">';
                }
                html += '<div class="user_name">'+row.user_name+'</div>';
                html += '<div class="public_'+row.public+'"></div>';
                html += '<div class="clear"></div>';
                html += '</div>';
            $('#recipe_list').append(html)
        }
    }

    buildRecipeList(recipe_list);

    $('.filter_form').ajax_form({
        'success': function(form, button, data) {
            if (data.success) {
                if (!button.hasClass('pagination')) {
                    $('#recipe_list .entry:not(.add_recipe)').remove();
                } 
                buildRecipeList(data.data);
                var query_string = form.serialize().replace(/page=[0-9]+/, '').replace(/&&/, '&').replace(/^&/, '').replace(/&&/, '');
                history.replaceState({}, '', self.location.href.replace(/\?.*$/, '') + '?' + query_string);
            }
            button.removeClass('pagination');
        },
        'beforesubmit': function(form, button) {
            if (!button.hasClass('pagination')) {
                $('.filter_form input[name="page"]').val(0);
            }
        },
    });

</script>


<?php require_once (DOCUMENT_ROOT . '/views/includes/footer.view.html'); ?>
